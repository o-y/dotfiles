"$schema" = "https://jj-vcs.github.io/jj/prerelease/config-schema.json"

# Useful references:
# - https://github.com/jj-vcs/jj/blob/main/docs/templates.md

[ui]
paginate = "never"
default-command = "log"

[user]
name = "zv"
email = "zv@zv.wtf"

[aliases]
l = ["log"]
n = ["new"]
e = ["edit"]
d = ["describe"]
c = ["commit"]
s = ["squash"]
sq = ["squash"]
rm = ["abandon"]
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]
consume = ["squash","--use-destination-message", "--keep-emptied", "--into", "@", "--from"]
eject = ["squash", "--use-destination-message", "--keep-emptied", "--from", "@", "--into"]

[merge-tools.meld]
program = "meld"

[signing]
behavior = "own"
backend = "gpg"

[snapshot]
auto-update-stale = true

[colors]
# Nodes
"node working_copy"  = "bright blue"
"node immutable"     = "bright black"
"node conflict"      = "bright red"
"node divergent"     = "bright red"

# Commit identifier (format_short_id)
"log commit change_id shortest prefix"  = { fg = "bright blue", bold = true }
"log commit change_id shortest rest"    = { fg = "bright black", dim = true}

"log commit divergent change_id shortest prefix"  = { fg = "bright red", bold = true }
"log commit divergent change_id shortest rest"    = { fg = "white", dim = false }

# Divergence / Conflict
"log commit divergent"  = { fg = "bright red", bold = true }
"log commit conflict"   = { fg = "red", bold = true }

# Author (zv vs others)
"log commit author zv"  = { fg = "bright yellow", bold = true }
"log commit author"     = "bright black"

# Descriptions
"log commit description"        = { fg = "white", bold = true }
"log commit empty_description"  = "bright black"

# Metadata
"log commit timestamp ago" = "bright black"
"log commit empty"         = "bright black"

# Domain Tags
"google" = { bg = "#68e2d0", bold = true, fg = "black" }
"dns"    = { bg = "red", bold = true, fg = "#ecf0f1" }

[template-aliases]
# Utility functions
'comment(text)' = ''
'format_short_id(id)' = 'id.shortest(4)'

# Logic for Blue 'zv' vs Gray others
'format_author' = '''
if(author.email().local() == "zv",
  label("author zv", author.email().local()),
  label("author", author.email().local())
)
'''

# Logic for commit ID with hidden/divergent labels
'format_short_change_id_with_change_offset(commit)' = '''
coalesce(
  if(commit.hidden(),
    label("hidden",
      format_short_change_id(commit.change_id()) ++ format_change_offset(commit),
    ),
  ),
  if(commit.divergent(),
    label("divergent",
      format_short_change_id(commit.change_id()) ++ format_change_offset(commit),
    ),
  ),

  if(commit.divergent(),
    label("divergent", format_short_change_id(commit.change_id())),
    format_short_change_id(commit.change_id())
  )
)
'''

# Logic for colored domain tags in descriptions
'format_description' = '''
if(description,
  truncate_end(100, coalesce(
    if(description.first_line().starts_with("[Google] "),
      label("google", "[Google]") ++ " " ++ description.first_line().remove_prefix("[Google] ")),
    if(description.first_line().starts_with("[DNS] "),
      label("dns", "[DNS]") ++ " " ++ description.first_line().remove_prefix("[DNS] ")),
    description.first_line()
  ), "…"),
  label("empty_description", "(no description set)")
)
'''

[templates]
# https://en.wikipedia.org/wiki/Box-drawing_characters
log_node = '''
label("node", coalesce(
  comment('# 1. Handle elided (hidden) revision ranges'),
  if(!self, "╪" ++ label("elided", "═")),

  comment('# 2. Current working copy (  icon with a corner connector)'),
  if(current_working_copy, "╭" ++ label("working_copy", "")),

  comment('# 3. Fixed glyphs for Conflicts (x) and Immutable commits (◆)'),
  if(conflict, label("conflict", "x")),
  if(immutable, "╽" ++ label("immutable", " ")),

  comment('# 4. Dynamic Node Generation'),
  comment('# Check if the commit has any parents. If parents.len() is 0,'),
  comment('# we use the corner "╭" to prevent lines from crossing off into nothing.'),
  comment('# Is a Head (no children above it)'),
  comment('# Is an Interior node (has children above it)'),
  if(self.contained_in("heads(all())"),
    if(divergent, "╭" ++ label("divergent", "╼"), "╭╼"),
    if(divergent, "├" ++ label("divergent", "╼"), "├╼")
  )
))
'''

log = '''
label(if(immutable, "immutable"),
  separate(" ",
    format_short_change_id_with_change_offset(self),
    format_author,
    committer.timestamp().ago(),
    bookmarks,
    tags,
    working_copies,
    if(empty, label("empty", "(empty)")),
    format_description,
    if(conflict, label("conflict", "CONFLICT")),
    if(divergent, label("divergent", "DIVERGENT")),
  )
) ++ "\n"
'''