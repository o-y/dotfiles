"$schema" = "https://jj-vcs.github.io/jj/prerelease/config-schema.json"

# Useful references:
# - https://github.com/jj-vcs/jj/blob/main/docs/templates.md

[ui]
paginate = "never"
default-command = "log"

[user]
name = "zv"
email = "zv@zv.wtf"

[aliases]
l = ["log"]
n = ["new"]
e = ["edit"]
d = ["describe"]
c = ["commit"]
s = ["squash"]
sq = ["squash"]
rm = ["abandon"]
# credits: https://github.com/thoughtpolice/a/blob/canon/tilde/aseipp/dotfiles/jj/config.toml
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]
consume = ["squash","--use-destination-message", "--keep-emptied", "--into", "@", "--from"]
eject = ["squash", "--use-destination-message", "--keep-emptied", "--from", "@", "--into"]

[merge-tools.meld]
program = "meld"

[signing]
behavior = "own"
backend = "gpg"

[snapshot]
auto-update-stale = true

[colors]
# Nodes
"node working_copy"  = "bright blue"
"node immutable"     = "bright black"
"node conflict"      = "bright red"
"node divergent"     = "bright red"

# Commit identifier (format_short_id)
"log commit change_id shortest prefix"  = { fg = "bright blue", bold = true }
"log commit change_id shortest rest"    = { fg = "bright black", dim = true}

"log commit divergent change_id shortest prefix"  = { fg = "bright red", bold = true }
"log commit divergent change_id shortest rest"    = { fg = "white", dim = false, bold = false }

"log commit conflict change_id shortest prefix"  = { fg = "bright red", bold = true }
"log commit conflict change_id shortest rest"    = { fg = "white", dim = false, bold = false }


# Divergence / Conflict
"log commit divergent"  = { fg = "bright red", bold = true }
"log commit conflict"   = { fg = "bright red", bold = true }

# Author (zv vs others)
"log commit author zv"  = { fg = "bright yellow", bold = true }
"log commit author"     = "bright black"

# Descriptions
"log commit description"        = { fg = "white", bold = true }
"log commit empty_description"  = "bright black"

# Metadata
"log commit timestamp ago" = "bright black"
"log commit empty"         = "bright black"

# Domain Tags
"ctx" = { fg = "#68e2d0", bold = true }
"dns"    = { fg = "red", bold = true }

[revset-aliases]
# credits:  https://github.com/thoughtpolice/a/blob/canon/tilde/aseipp/dotfiles/jj/config.toml
'user(x)' = 'author(x) | committer(x)'
'mine()' = 'user(exact:"zv@zv.wtf") | user(exact:"zv-corp@zv.wtf")'

[template-aliases]
# Utility functions
'comment(text)' = ''
'format_short_id(id)' = 'id.shortest(4)'

# Logic for Blue 'zv' vs Gray others
'format_author' = '''
if(author.email().local() == "zv",
  label("author zv", author.email().local()),
  label("author", author.email().local())
)
'''

# Logic for colored domain tags in descriptions
'format_description' = '''
if(description,
  truncate_end(100, coalesce(
    if(description.first_line().starts_with("[CTX] "),
      label("ctx", "[CTX]") ++ " " ++ description.first_line().remove_prefix("[CTX] ")),
    if(description.first_line().starts_with("[DNS] "),
      label("dns", "[DNS]") ++ " " ++ description.first_line().remove_prefix("[DNS] ")),
    description.first_line()
  ), "…"),
  label("empty_description", "(no description set)")
)
'''

# Logic for commit ID with hidden/divergent labels
'format_short_change_id_with_change_offset(commit)' = '''
coalesce(
  if(commit.conflict(), label("conflict", format_short_change_id(commit.change_id()))),
  if(commit.hidden(),
    label("hidden", 
      separate("", format_short_change_id(commit.change_id()), format_change_offset(commit))
    )
  ),
  if(commit.divergent(),
    label("divergent", 
      separate("", format_short_change_id(commit.change_id()), format_change_offset(commit))
    )
  ),
  format_short_change_id(commit.change_id())
)
'''

[templates]
# https://en.wikipedia.org/wiki/Box-drawing_characters
log_node = '''
label("node", coalesce(
  comment('# 1. Elided revisions (2 chars)'),
  if(!self, "╪" ++ label("elided", "═")),

  comment('# 2. Visible commits (Connector + Glyph = 2 chars)'),
  concat(
    comment('# Pick Connector'),
    if(self.contained_in("heads(all())"), "╭", "├"),

    comment('# Pick Glyph (The icon)'),
    coalesce(
      if(current_working_copy, label("working_copy", "")),
      if(conflict, label("conflict", "x")),
      if(divergent, label("divergent", "╼")),
      if(immutable, label("immutable", "╼")),
      "╼"
    )
  )
))
'''

log = '''
label(if(immutable, "immutable"),
  separate(" ",
    format_short_change_id_with_change_offset(self),
    format_author,
    committer.timestamp().ago(),
    bookmarks,
    tags,
    working_copies,
    if(empty, label("empty", "(empty)")),
    format_description,
    if(conflict, label("conflict", "CONFLICT")),
    if(divergent, label("divergent", "DIVERGENT"))
  )
)
'''

# Connor's going viral.
# https://github.com/thoughtpolice/a/blob/canon/tilde/aseipp/dotfiles/jj/config.toml#L310
git_push_bookmark = '"zv/jj/" ++ stringify(truncate_end(32, description.first_line().lower())).replace(regex:"[^a-zA-Z0-9]+", "-").replace(regex:"^-.*", "").replace(regex:"-*$", "") ++ "/" ++ change_id.short(4)'